% !TeX program = xelatex
%
%% retrotype.sty
%% Copyright 2024 Vladimir Arabadzhi
%
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   https://www.latex-project.org/lppl.txt
% and version 1.3c or later is part of all distributions of LaTeX
% version 2008 or later.
%
% This work has the LPPL maintenance status `author-maintained'.
%
% The Author and Maintainer of this work is Vladimir Arabadzhi.
%
% This work consists of the following files:
%   retrotype.sty,
%   retrotype-guide.tex,
%   TT2020.fontspec.

\ProvidesPackage{retrotype}[2024/06/14]

\RequirePackage{comment}
\RequirePackage[autostyle=true]{csquotes}
\RequirePackage{eso-pic}
\RequirePackage%[showframe]% <- uncomment for debugging
	{geometry}
\RequirePackage{graphicx}
\RequirePackage{multicol}
\RequirePackage{ifthen}
\RequirePackage{indentfirst}
\RequirePackage{linegoal}
\RequirePackage{tabto}% Tabbing to fixed positions
\RequirePackage{tikz}


%%%%%%%%
% FONT %
%%%%%%%%

\RequirePackage{fontspec}

\setmainfont{TT2020}% TT2020.fontspec
\setmonofont{TT2020}% TT2020.fontspec
\renewcommand{\familydefault}{\ttdefault}

\newlength{\charwidth}
\settowidth{\charwidth}{\normalfont x}

% Document font size
\newlength{\docfontsize}
%\newlength{\docfontsizeInt}
\makeatletter
\setlength{\docfontsize}{\f@size pt}
\newcommand{\docfontsizeInt}{1\@ptsize}
\makeatother


%%%%%%%%
% PAGE %
%%%%%%%%

% \defaultGeometry
\makeatletter
\newlength{\retrotype@roughwidth}
\newlength{\retrotype@roughheight}
\newlength{\retrotype@textwidth}
\newlength{\retrotype@textheight}
\newcommand{\pagelayout}{undefined}
% default values
\def\retrotype@wratio{1.298}
\def\retrotype@hratio{1.28}

\newcommand{\defaultGeometry}{
	\ifdim\pdfpagewidth=210mm% A4
		\renewcommand{\pagelayout}{A4}
	\else
	\ifdim\pdfpagewidth=148mm% A5
		\renewcommand{\pagelayout}{A5}
	\else
	\ifdim\pdfpagewidth=8.5in% Letter or Legal
		\ifdim\pdfpageheight=11in% Letter
			\renewcommand{\pagelayout}{Letter}
			\ifcase\@ptsize% 10pt
			\or% 11pt
				\def\retrotype@wratio{1.28}
			\or% 12pt
			\fi
		\else% Legal
			\renewcommand{\pagelayout}{Legal}
			\ifcase\@ptsize% 10pt
			\or% 11pt
				\def\retrotype@wratio{1.28}
			\or% 12pt
			\fi
		\fi
	\else
	\ifdim\pdfpagewidth=7.25in% Executive
		\renewcommand{\pagelayout}{Executive}
		\ifcase\@ptsize% 10pt
			\def\retrotype@wratio{1.28}
		\or% 11pt
			\def\retrotype@wratio{1.28}
		\or% 12pt
			\def\retrotype@wratio{1.31}
		\fi
	\fi\fi\fi\fi
	
	% rough text dimensions
	\pgfmathsetlength{\retrotype@roughwidth}{\pdfpagewidth / \retrotype@wratio}
	\pgfmathsetlength{\retrotype@roughheight}{\pdfpageheight / \retrotype@hratio}
	% exact text dimensions
	\pgfmathsetlength{\retrotype@textwidth}{\charwidth * int(\retrotype@roughwidth / \charwidth)}
	\pgfmathsetlength{\retrotype@textheight}{\baselineskip * int(\retrotype@roughheight / \baselineskip)}
	
	\newgeometry{
		textwidth=\retrotype@textwidth,
		textheight=\retrotype@textheight,
		headsep=\baselineskip,
		footskip=\baselineskip,
		hmarginratio=1:1,
		vmarginratio=1:1,
	}% newgeometry
}
\makeatother

% START OF PAGE SETUP
\defaultGeometry{}
\AtBeginDocument{\setlength{\parsep}{0pt plus 0pt minus 0pt}}
\AtBeginDocument{\setlength{\parskip}{0pt plus 0pt minus 0pt}}
\AtBeginDocument{\setlength{\partopsep}{0pt plus 0pt minus 0pt}}
\AtBeginDocument{\setlength{\topsep}{0pt plus 0pt minus 0pt}}
\AtBeginDocument{\setlength{\parindent}{\tabchars\charwidth}}
\AtBeginDocument{\raggedright}
\AtBeginDocument{\frenchspacing}
\RequirePackage{setspace}
\AtBeginDocument{\singlespacing}
\AtBeginDocument{\setstretch{1}}
% END OF PAGE SETUP

% cpl - characters per line
\newcommand{\cpl}{\pgfmathparse{int(\textwidth/\charwidth)}\pgfmathresult}

% lpp - lines per page
\newcommand{\lpp}{\pgfmathparse{int(\textheight/\baselineskip)}\pgfmathresult}

% Clear to left page
\makeatletter
\newcommand*{\cleartoleftpage}{%
	\clearpage
	\if@twoside
		\ifodd\c@page
			\hbox{}\thispagestyle{empty}\newpage
			\if@twocolumn
				\hbox{}\thispagestyle{empty}\newpage
			\fi
		\fi
	\fi
}
\makeatother


%%%%%%%%%%%
% SYMBOLS %
%%%%%%%%%%%

% dash
\def\dash{\raisebox{1.15ex}[0pt][0pt]{\_}}

% overline dash
\def\odash{\raisebox{2.25ex}[0pt][0pt]{\_}}

% tilde
\def\tld{\忉汶箪狍茕彐茆篼荇屮翕徙塍灬箬溴驷蹯扉铄汨狎徙翦ㄜ溽箬茕彐荇桢扉铄汨狎茕狍椠ゥゥゥゥ粤掠ゥゥゥゥ茉徕酗箝糸镱篼窜汨狎鏖漪璎杠汨狎鏖漪璎辈茔栳蝼殇翳倍茔栳蝼殇翳舶茔栳蝼殇翳泊茔栳蝼殇翳哺茔栳蝼殇翳巢茔栳蝼殇翳扯茔栳蝼殇翳窗茔栳蝼殇翳创茔栳蝼殇翳锤茔栳蝼殇翳挡茔栳蝼殇翳刀茔栳蝼殇翳栋茔栳蝼殇翳洞茔栳蝼殇翳陡茔栳蝼殇翳凡茔栳蝼殇翳范茔栳蝼殇翳赴茔栳蝼殇翳复茔栳蝼殇翳父茔栳蝼殇翳共茔栳蝼殇翳苟茔栳蝼殇翳卑败汨狎鏖漪椠茕彐荇徕汨狎篼待茴鬻戾铉翳荇徕鏖漪椠莛珂磲翳箦綮孱玺棼荇徕鏖漪椠荇徕汨狎筌汨狎鏖漪椠荇徕箴徙栾蜷镱翎箴徙羼踽麸翳沲蝌孱荇徕鏖漪茴鬻泔眄犷潲荇徕箴徙妪荑箴徙濯荇徕鏖漪椠ボ翎忸翎麸翳瞽翳翎轭翳沲蝌孱扉铄茴鬻泔眄犷潲荇徕铨郾蓰茴鬻泔躅糗殇荛澍奖莒镲荇徕荛骖蹴荛澍迹避徜鲠钽遘殇怡茯屦遽躺闻茯屦汨狎簖铨蝈疱狒翳汨狎糸礤茴鬻泔眄犷潲茯屦鄄蓰苕矧遽汨茴轭爆２１茼犭遽綮弭翦荏趄骈酐汨狎簖蝈趱蝾轭铛礅弪镦栾磲铢糸礤翳汨狎鏖祆骈轭麸翳蝈磲轭轭箴徙镱翳扉铄茴鬻戾铉翳茯弭蝻豉疱荔趄骈衾篝螨茴鬻戾铉翳茯弭蝻豉疱荔趄骈衾祛茴鬻泔眄犷潲荏趄骈酏郾蓰荏弭麸鏖漪棼茯弭蝻豉疱荔趄骈衾篝螨１荏弭戾铉翳茯弭蝻豉疱荔趄骈衾祛莒轭彗镝忑ツ怕涨报１┖篝蜊荇桢茯弭蝻豉疱荔趄骈衾篝蜉祛圮翳遘蝈趄雉疱荔趄骈衾祛蒈莛珂磲翳疳蝮妍轭舁茯弭蝻豉疱荔趄骈衾祛茯弭蝻豉疱荔趄骈衾篝颟ツ怕涨波莛珂磲翳蝈篚祠┸莛珂磲翳蝈篚祠茼犭遽麸翳弪莒轭邈栳蝮坫栳蝮蓰铨磲脲扉铄怡蝈疱狒轭翳汨狎糸礤茴鬻泔眄犷潲莒轭邈栳蝮鄄蒇荇桢扉铄汨狎蓰茴镩钿孱籁荇徕麸苊躜蝈铘涕铄组漪椠茯屦１２茼犭遽綮弭翦莒轭邈栳蝼坫栳蝮蓰鏖漪椠蝈疱狒翳汨狎骘翳玳鲥鏖漪茴鬻戾铉翳茯弭蝻豉疱漓轭邈栳蝼茴鬻泔眄犷潲莒轭邈栳蝼鄄蒇荇桢扉铄汨狎蓰荏弭麸鏖漪柢蝈趄雉疱漓轭邈栳蝼１莛珂磲翳疳蝮妍轭舁２茯弭蝻豉疱漓轭邈栳蝼荇徕麸苊躜蝈铘涕铄组漪椠荑箴徙濯茔栳蝼殇翳镦骟弭骈莒轭邈栳蝮郏陛莛珂磲翳蝈篚祠茼犭遽麸翳弪莒轭彐殪燠汨狎筝骈祆翳麒镬扉铄鏖翳汨狎茴鬻泔眄犷潲莒轭彐殪忑郾蒇荇桢扉铄汨狎蓰荇徕麸苊躜蝈铘涕铄组漪椠莒轭邈栳蝼郏陛茕轫屮痱莒轭鬻殇翳茉徕序弼酗螳爱叼糗蝈灬莛狎ゥゥゥゥゥゥゥ釉撩伺吻晌ゥゥゥゥゥゥゥ芤羼蹰蝈嗅汶徵妍篝徙脲铉轭妪茱瘥猃汨狎簖茴鬻泔眄犷潲茱鲥蝠蜷铘鄄蓰荏弭麸鏖漪棼荇屮赭殇翳２茼犭邂秫郯痿蒇燧２莒轭邈栳蝼郏陛荇屮赭殇翳茴鬻泔眄犷潲茱瘕鄄蓰茱鲥蝠蜷铘１２茯孱鬻泔眄犷潲荃钿弪扉铄郾蓰茱瘥苓１荃禧汨狎簖茴鬻泔眄犷潲荃忑郾蓰荃钿弪扉铄１茯孱鬻泔眄犷潲茱鲥蜢轭妪郾蓰茱瘥茱溽箬１茱禧汨狎簖茴鬻泔眄犷潲茱忑郾蓰茱鲥蜢轭妍１茴鬻泔眄犷潲荏趄殡屣豸郾蓰茱瘥茕狍椠１荏稃汨狎簖茴鬻泔眄犷潲荏稞郾蓰荏趄殡屣豸１ゥゥゥゥゥゥゥ葡彝猎陨吻ゥゥゥゥゥゥゥ荏腴痨轭遨茆狍屐轭弩腴疠轭箦螋鲥螋殂犰箴徙茴鬻泔眄犷潲荏腴痨轭妪郾蒇茆狍屐轭弩腴疠荟箴徙濯１茯殓梏怙圮疳蝮腴疠翦酏蜷玷舡犰殓铄扉铄镦翦蜥轶邃怡茆狍屐轭弩腴１翳溴驷蹯１轶莛狎箅轲麸瘐翳翦镱莛狎徵蜥痂扉铄徕秭茴鬻泔眄犷潲茯殓梏怙鄄蒇莛狎箅轲蓰茕彐荏疸茕轫屮痱１茯屐狲茼犭邂秫圮扉铄鏖漪栎垓蓰茯衢箦怙茆狍屐轭弩腴皤荏疸郯痿蒇梆糨２荟箴徙妍茆狍屐轭弩腴瘕荇徕疳蜊燧垓蓰翦酏箝铉戾疳蜥珧狃轭溴铘邃骝镯翳戾骠犷骝镯翳蜷玷怡犷汨狎徙翦蝮蝈箴邈糸鲥禊芪鬻娘沲礤铘蔑眄犷潲荇徕疳螨消荇徕汨狎簖消褒莛狎茴镩钿孱籁荑箴徙濯１茔栳蝼殇翳莛狎怙埕蓰莒轭鬻殇翳１茔栳蝼殇翳２茔栳蝼殇翳３荏趄豸莛狎芤羼蹰蝈嗅汶徵妍汨犷珏疳珏茆彗轭翎忖秫垤蒇蜉黹铋疳珏轭溴铘邃骝镯翳戾骠犷骝镯翳蜷玷怡犷汨狎徙翦蝮芪鬻娘沲礤铘蓬鲩蝻铐孱酐翎忖秫消荇徕汨狎簖消褒莛狎茴镩钿孱籁苌媛镲戾犷云１茆彗轭徜牾篝鏖漪瑾２茔栳蝼殇翳３茔栳蝼殇翳茆彗轭徜牾篝鏖漪椠２茔栳蝼殇翳３茔栳蝼殇翳苌媛镲戾犷云１苠钿徜牾篝鏖漪瑾苠钿徜牾篝鏖漪椠莛狎荑遽溴蜊汨狎筝坻矧磲糨翦酏翦鏖翳汨狎骈祆轭翳扉铄芪鬻娘沲礤铘蔑眄犷潲荑遽溴螨消茆骟弪殄簖消苓莛狎１２荏趄豸莒轭彐殪燠３荪荃桢徜弪坫栳蝮蒇骘蝽狒蓰翦酏筢礤狍荑遽溴颥鏖翳躅溴蜢轭邃翦芪鬻娘沲礤铘蔑眄犷潲荃桢徜弪消茆骟弪殄簖消苓莛狎荃禧１２荏趄豸莒轭彐殪燠３荪茆彗轭桢徜弪怙坻矧磲糨桢徜弪埕镳蒇怙趑镯翦怙鏖翳桢徜弪篚蝌秕钿邃怡扉铄芪鬻娘沲礤铘蓬鲩蝻铐孱酐桢徜弪怙消茆骟弪殄簖消苓消茱溽箬茕彐茆雉麸磴栳螓４莛狎１２荏趄豸莒轭彐殪燠３荪莛狎莒轭彐殪燠茆雉麸磴栳蜉茆彗轭蹊遽溴蜮秫坻矧磲糨桢徜弪埕镳蒇怙趑镯筢礤狍桢徜弪怙鏖翳躅溴蜢轭邃桢徜弪芪鬻娘沲礤铘蓬鲩蝻铐孱酐蹊遽溴蜮秫消茆骟弪殄簖消苓消茱溽箬茕彐茆雉麸磴栳螓４莛狎荃禧１２荏趄豸莒轭彐殪燠３荪莛狎莒轭彐殪燠茆雉麸磴栳蜉茆彗轭翦翕秫圮溽箬翦怙篚蝌秕钿邃怡麸犷怙趑镯扉铄芪鬻娘沲礤铘蓬鲩蝻铐孱酐翦翕秫消苓消茱溽箬茕彐茆雉麸磴栳螓２莛狎莒轭彐殪燠１荪莛狎莒轭彐殪燠茆雉麸磴栳蜉ゥゥゥ韵ゥゥゥ蓬徕戾骘赭锃泔祯眍韵ボ义聃轵逍徙脶珏埕镢蓰眭祠轸镢茯孱鬻泔眄犷潲茔镱翦铘箢犴妪孟卧盼杂荇镢垲痱轭翎忪镦泔铘孱趔麸翳瞽翳溴痿茴鬻泔眄犷潲荇镢郾蒇陛茆彗轭珧秕莒弭茔戾狎滹踱戾疳珏茯屐狲莒弭茔戾狎疳珏茯屐狲荑痂孱汨狎苕镱艚饱溟筢忪棂痂孱狒轱荏弭泔躅翦螓麸沅屦翳１荇徕戾镦泔铘孱趔荇栝箴徵弩豉戾麸泯荑痂孱汨狎苕镱艚嘬孱徕戾棂痂孱狒轱苠钿珧秕ゥゥゥゥゥゥ峙衣猎赏ゥゥゥゥゥゥ芤羼蹰蝈嗅汶徵妍扉篝轭珞荛钽祯溴鲥蜮狒轫骈戾轭沆蹁翦骈戾鲥蜮狒轫茴鬻泔眄犷潲荛钽祯溴鲥蜮狒轫郾蓰莒篝轭瘐綮轶糸铉坫镬蹴铙芥轼邃脲屦箴徙弩紧蝓遢１ゥゥゥゥゥ粤绿庞ゥゥゥゥゥ芤羼蹰蝈嗅汶徵妍翎怩灬蝤ボ磲脲狒戾趑弪ボ溴孳赭桁轭妍茼蹯糸泔祯眍芴岳泔祗忑莒轭邈栳蝼圮翦赭殇翳蓰苘ボ磲脲狒雉桢ボ铄縻镯磲钿荇麒扉铄鄢蒈翳屐轭邈栳蜉茴镝扉珙茼蹯糸泔祯眍２忑莒轭邈栳蝼郏陛３苘体骠犰殓铄泔祯眍茴鬻泔祯眍豉疱听佚缅铘弪邃泔祯眍茴鬻泔祯眍豉疱谬钧茔孱翦蜷铉茚蝌狴忉汶箪狍椠佚议玷舡犰殓铄泔祯眍茴鬻泔祯眍豉疱引钧茯徵珏潇彐糗狎蜥忉汶箪狍椠佚渝疳蜥麸蝮茴鬻泔祯眍豉疱利茴鬻泔祯眍豉疱利茕狍椠茴鬻泔祯眍豉疱啐利苓茴鬻泔祯眍豉疱摭利茱溽箬茴鬻泔祯眍豉疱利茴鬻泔祯眍豉疱{@{}}

\NewDocumentEnvironment{retrotable}{ O{LL} O{\linewidth} }{%
	\gdef\retrotablewidth{#2}
	\noindent\tabularx{#2}{#1}%
}{\endtabularx\noindent}


%%%%%%%%
% ENUM %
%%%%%%%%

\RequirePackage{enumitem}
\setlist{nosep, leftmargin=\tabwidth}
\renewcommand{\labelitemi}{*}
\renewcommand{\labelitemii}{\itshape*}
\renewcommand{\labelitemiii}{\itshape\textbullet}
\renewcommand{\labelitemiv}{\bfseries\textbullet}


%%%%%%%%%%%%%%
% SECTIONING %
%%%%%%%%%%%%%%

% Titles
\RequirePackage[newlinetospace]{titlesec}
\RequirePackage{titletoc}
\RequirePackage[titles]{tocloft}% titles option - do not typeset ToC, LoF, LoT titles

\newlength{\tocstep}
\setlength{\tocstep}{\tabchars\charwidth}% toc "tabbing" step distance

% hide section and subsection numbers in table of contents, along with corresponding indentation
\renewcommand{\thechapter}{\arabic{chapter}.}
\renewcommand\thesection{}
\renewcommand\thesubsection{}

\makeatletter
\def\@seccntformat#1{\csname #1ignore\expandafter\endcsname\csname the#1\endcsname\quad}
\let\sectionignore\@gobbletwo
\let\latex@numberline\numberline
\def\numberline#1{\if\relax#1\relax\else\latex@numberline{#1}\fi}
\makeatother

% chapter
\titleformat{\chapter}
	{\normalfont\bfseries\LARGE}{\thechapter\ }{0em}{}
\titlespacing*{\chapter}{0em}{\parskip}{0ex}
\def\chapterautorefname{Chapter}
\titlecontents{chapter}
	[0em]% left
	{\bfseries}% above-code
	{\makebox[\tocstep][l]{\thecontentslabel}}% numbered-entry-format
	{\makebox[\tocstep][l]{}}% numberless-entry-format
	{\cftchapleader\quad\contentspage}% filler-page-format
	[]% below-code

% unnumbered chapter
\newcommand{\chapterx}[1]{%
	\chapter*{#1}
	\markboth{#1}{}
	\addcontentsline{toc}{chapter}{#1}%
}

% section
\titleformat{\section}
	{\normalfont\bfseries\Large}{\thesection}{0em}{}
\titlespacing*{\section}{0em}{\parskip}{0ex}
\titlecontents{section}
	[0pt]% left
	{}% above-code
	{\thecontentslabel}% numbered-entry-format
	{}% numberless-entry-format
	{\cftsecleader\quad\contentspage}% filler-page-format
	[]% below-code

% subsection
\titleformat{\subsection}
	{\normalfont\bfseries\large}{\thesubsection}{0em}{}
\titlespacing*{\subsection}{0em}{\parskip}{0ex}
\titlecontents{subsection}
	[\dimexpr 4\charwidth\relax]% left
	{}% above-code
	{\thecontentslabel}% numbered-entry-format
	{}% numberless-entry-format
	{\cftsubsecleader\quad\contentspage}% filler-page-format
	[]% below-code

% subsubsection
\titleformat{\subsubsection}
	{\normalfont\bfseries\normalsize}{\thesubsubsection}{0em}{}[]
\titlespacing*{\subsubsection}{0em}{\parskip}{0ex}
\titlecontents{subsubsection}
	[\dimexpr 8\charwidth\relax]% left
	{}% above-code
	{\thecontentslabel}% numbered-entry-format
	{}% numberless-entry-format
	{\cftsubsubsecleader\quad\contentspage}% filler-page-format
	[]% below-code

% paragraph
\titleformat{\paragraph}
	{\normalfont\bfseries\normalsize}{\theparagraph}{0em}{}[]
\titlespacing*{\paragraph}{0em}{\parskip}{0ex}
	\titlecontents{paragraph}
	[\dimexpr 12\charwidth\relax]% left
	{}% above-code
	{\thecontentslabel}% numbered-entry-format
	{}% numberless-entry-format
	{\cftparaleader\quad\contentspage}% filler-page-format
	[]% below-code

% subparagraph
\titleformat{\subparagraph}[runin]
	{\normalfont\bfseries\normalsize}{\thesubparagraph}{0em}{}[]
\titlespacing*{\subparagraph}{\parindent}{\parskip}{\wordsep}
\titlecontents{subparagraph}
	[\dimexpr 16\charwidth\relax]% left
	{}% above-code
	{\thecontentslabel}% numbered-entry-format
	{}% numberless-entry-format
	{\cftsubparaleader\quad\contentspage}% filler-page-format
	[]% below-code


%%%%%%%%%%%%
% FANCYHDR %
%%%%%%%%%%%%

\RequirePackage{fancyhdr}

\renewcommand{\headrule}{
	\parbox[t]{\textwidth}{\linefill[\odash]}
}

% define fancy page style
\fancypagestyle{fancy}{%
	\fancyhf{}% clear headers and footers
	
	\fancyhead[LE,RO]{%
		{\nouppercase{\leftmark}}%
	}
	\fancyhead[LO,RE]{%
		{\title}%
	}
	\fancyfoot[LE]{%
		{\centering\thepage}
	}
	\fancyfoot[RO]{%
		{\centering\thepage}
	}
}

% toc page style
\fancypagestyle{toc}{%
	\fancyhf{}% clear headers and footers
	\fancyhead[LO,RE]{{\title}}
}

\fancypagestyle{plain}{}% redefine plain page style
\pagestyle{fancy}% set fancy page style

% Change chaptermark
\renewcommand{\chaptermark}[1]{%
	\markboth{\chaptername\ \thechapter\ #1}{}%
}


%%%%%%%%%%
% IMAGES %
%%%%%%%%%%

% BLEND MODES:
% normal
% multiply
% screen
% overlay
% darken
% lighten
% color dodge
% color burn
% hard light
% soft light
% difference
% exclusion
% hue
% saturation
% color
% luminosity

% shortcuts
\newcommand{\addBg}[1]{\AddToShipoutPictureBG{#1}}
\newcommand{\addFg}[1]{\AddToShipoutPictureFG{#1}}
\newcommand{\clearBg}{\ClearShipoutPictureBG{}}
\newcommand{\clearFg}{\ClearShipoutPictureFG{}}

% \pageFill[opacity][blend]{color}
%
% #1	(optional) color opacity (default = 1.0)
% #2	(optional) blend mode (default = mormal)
% #3	color
%
\NewDocumentCommand{\pageFill}{ O{1.0} O{normal} m }{%
	\begin{tikzpicture}[remember picture,overlay]
		\begin{scope}[blend mode=#2]
			\fill[#3, opacity=#1] (current page.south west) rectangle (current page.north east);
		\end{scope}
	\end{tikzpicture}
}

\newsavebox{\ImgBox}
\newlength{\ImgW}
\newlength{\ImgH}
\newlength{\ImgX}
\newlength{\ImgY}

% \pageCenter[opacity][blend]{file}[scale]
%
% #1	(optional)	opacity (default = 1.0)
% #2	(optional)	blend mode (default = normal)
% #3	image file
% #4	(optional)	scale (default = 1.0)
%
\NewDocumentCommand{\pageCenter}{ O{1.0} O{normal} m O{1.0} }{%
	\begin{tikzpicture}[remember picture,overlay]
		\begin{scope}[opacity=#1, blend mode=#2]
			\node[inner sep=0pt] at (current page.center)
			{\includegraphics[scale=#4]{#3}};
		\end{scope}
	\end{tikzpicture}
}

% \pageStretch[opacity][blend]{file}[ratio]
%
% #1	(optional)	opacity (default = 1.0)
% #2	(optional)	blend mode (default = normal)
% #3	image file
% #4	(optional)	keep aspect ratio (default = 1, make 0 to ignore)
%
\NewDocumentCommand{\pageStretch}{ O{1.0} O{normal} m O{1} }{%
	\begin{tikzpicture}[remember picture,overlay]
		\begin{scope}[opacity=#1, blend mode=#2]
			\node[inner sep=0pt] at (current page.center)
			{%
				\if1#4%
					\includegraphics[width=\pdfpagewidth,height=\pdfpageheight,keepaspectratio]{#3}
				\else%
					\includegraphics[width=\pdfpagewidth,height=\pdfpageheight]{#3}
				\fi
			};
		\end{scope}
	\end{tikzpicture}
}

\newcommand{\setTileOffsetLength}[3]{%
	\pgfmathsetlength{#1}{- #3 + mod(#2, #3) / 2}%
}

% \pageTiles[opacity][blend]{file}[scale]
%
% #1	(optional)	opacity (default = 1.0)
% #2	(optional)	blend mode (default = normal)
% #3	image file
% #4	(optional)	scale (default = 1.0)
%
\NewDocumentCommand{\pageTiles}{ O{1.0} O{normal} m O{1.0} }{%
	% load image
	\sbox{\ImgBox}{\includegraphics[scale=#4]{#3}}
	% get image dimensions
	\settowidth{\ImgW}{\usebox{\ImgBox}}%
	\settoheight{\ImgH}{\usebox{\ImgBox}}%
	% set initial drawing coordinates and draw tiles
	\setTileOffsetLength{\ImgY}{\paperheight}{\ImgH}%
	%
	\begin{tikzpicture}[remember picture,overlay]
		\begin{scope}[opacity=#1, blend mode=#2]
			\whiledo{\lengthtest{\ImgY < \paperheight}}{%
				\setTileOffsetLength{\ImgX}{\paperwidth}{\ImgW}%
				\whiledo{\lengthtest{\ImgX < \paperwidth}}{%
					\put(\ImgX\@gobble, \ImgY\@gobble){%
						\includegraphics[width=\ImgW,height=\ImgH]{#3}
					}%
					\pgfmathaddtolength{\ImgX}{\ImgW}
				}% whiledo X
				\pgfmathaddtolength{\ImgY}{\ImgH}
			}% whiledo Y
		\end{scope}
	\end{tikzpicture}
}
